# linux中的页表(pte)

## 独立的页表 和 共享的内核页表

1. 每个进程都有独立页表
   - 每个进程在用户空间都有自己独立的页表。这个页表用于将用户空间的虚拟地址映射到物理地址。页表通常时多级结构，具体取决于体系结构
2. 内核代码共享的内核页表
   - 内核空间的虚拟地址映射在所有的进程中时共享的。在每个进程的页表中，都包含了一部分内核页表，以便当进程进入内核态时可以访问内核空间。内核空间通常位于虚拟地址空间的高地址部分。

## 页表的功能
- 存储虚拟地址与物理地址的映射关系
    - 页表条目(PTE)包含虚拟地址到物理地址的映射关系以及页面的状态信息(如权限，缓存属性等)

## 访问内存

- 通过页表查询物理地址：
  - 当进程访问虚拟内存地址时，MMU（内存管理单元）会通过查找页表来将虚拟地址转换为物理地址。若**页表中没有相应的条目（即页面不在内存中），会触发缺页异常**，内核将处理这个异常并可能将页面调入内存。

## 内存分配与页表项

- zone和伙伴系统管理物理内存：
  - 内核中的zone表示物理内存的不同区域（如DMA区、普通区和高端内存区）。伙伴系统算法用于高效地管理和分配这些物理内存区域中的页面。

- 分配内存时创建新的页表项：
  - 当需要为进程分配新的物理内存页面时（例如在进程触发缺页异常时），内核会从伙伴系统中分配一个或多个物理页面，并在相应的页表中创建新的页表项，建立虚拟地址到物理地址的映射。

## 具体步骤
1. 进程访问虚拟内存地址：
- 通过页表查找物理地址，如果页表中有条目（TLB命中），MMU直接将虚拟地址转换为物理地址。
- 如果页表中没有条目（TLB未命中），触发缺页异常，内核处理该异常。

2. 内核处理缺页异常：
- 确定所需的页面是否在物理内存中。
- 如果页面不在内存中，从磁盘（swap空间或文件系统）读取页面到物理内存。
- 从伙伴系统分配一个新的物理页面。
- 更新进程的页表，创建新的页表项。

3. 更新页表：
- 将分配的物理页面地址写入页表项中，并设置相应的控制标志（如可读、可写等）。